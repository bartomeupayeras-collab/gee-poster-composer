<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compositor de pòster (GEE)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111; }
    header { padding: 14px 16px; background:#fff; border-bottom:1px solid #e6e8f0; position:sticky; top:0; z-index:5; }
    header h1 { font-size: 16px; margin:0; }
    header .sub { font-size: 12px; color:#444; margin-top:4px; }
    main { padding: 14px 16px; display:grid; grid-template-columns: 360px 1fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){ main{ grid-template-columns: 1fr; } }
    .card { background:#fff; border:1px solid #e6e8f0; border-radius: 14px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { font-size: 12px; color:#333; display:block; margin: 10px 0 6px; }
    input, textarea { width:100%; box-sizing:border-box; border:1px solid #d8dbe6; border-radius: 10px; padding: 10px; font-size: 13px; background:#fff; }
    textarea { min-height: 68px; resize: vertical; }
    button { border:0; border-radius: 12px; padding: 10px 12px; font-weight: 700; cursor:pointer; }
    button.primary { background:#111; color:#fff; }
    button.secondary { background:#eef1f8; color:#111; }
    .hint { font-size: 12px; color:#555; margin-top: 8px; line-height: 1.35; }
    .err { color:#b00020; font-size: 12px; margin-top: 8px; white-space: pre-wrap; }
    canvas { width:100%; height:auto; background:#fff; border:1px solid #e6e8f0; border-radius: 14px; }
    .tiny { font-size:11px; color:#666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 11px; }
  </style>
</head>
<body>
<header>
  <h1>Compositor de pòster (GEE)</h1>
  <div class="sub">Obre'l des del visor. Compatible amb <span class="mono">?p=</span> (payload) o amb paràmetres clàssics (<span class="mono">?map=</span>).</div>
</header>

<main>
  <section class="card">
    <div class="row">
      <button class="primary" id="btnRender">Generar / Actualitzar</button>
      <button class="secondary" id="btnDownload">Descarregar PNG</button>
    </div>
    <div class="hint">
      Des del visor, l'enllaç sol venir com <span class="mono">?p=...</span> (payload). Si vols provar manualment:
      <span class="mono">?map=&lt;MAP_URL&gt;&amp;title=...&amp;subtitle=...&amp;min=...&amp;max=...&amp;unit=...</span>
    </div>

    <label>URL del mapa (PNG) *</label>
    <input id="mapUrl" placeholder="getThumbURL del mapa base (PNG)" />

    <label>Títol</label>
    <input id="title" placeholder="Ex: Comparador insular" />

    <label>Subtítol (1–3 línies)</label>
    <textarea id="subtitle" placeholder="Ex: Variable · Mode · Data"></textarea>

    <div class="row">
      <div style="flex:1">
        <label>Min</label>
        <input id="vmin" placeholder="Ex: 0.12" />
      </div>
      <div style="flex:1">
        <label>Max</label>
        <input id="vmax" placeholder="Ex: 0.78" />
      </div>
      <div style="flex:1">
        <label>Unitat</label>
        <input id="unit" placeholder="Ex: NDVI" />
      </div>
    </div>

    <label>Paleta (hex separats per coma)</label>
    <input id="palette" placeholder="Ex: 440154,3b528b,21918c,5ec962,fde725" />

    <div class="row">
      <div style="flex:1">
        <label>Escala (km)</label>
        <input id="scaleKm" placeholder="Ex: 50" />
      </div>
      <div style="flex:1">
        <label>Nom marca</label>
        <input id="brand" placeholder="Càtedra de la Insularitat" />
      </div>
    </div>

    <label>Peu</label>
    <input id="footer" placeholder="Ex: GEE · Copernicus · Consell Insular" />

    <div class="tiny" style="margin-top:10px;">
      Si el mapa no carrega o la descàrrega falla, sol ser CORS. Solució: afegir proxy o carregar PNG local (es pot afegir si ho necessites).
    </div>

    <div class="err" id="err"></div>
  </section>

  <section class="card">
    <canvas id="c" width="2400" height="1600"></canvas>
  </section>
</main>

<script>
(function(){
  function qs(k){ return new URLSearchParams(location.search).get(k); }
  function setIf(id, v){ if(v!==null && v!==undefined && v!==""){ document.getElementById(id).value = v; } }
  function sanitize(s){ return (s===null||s===undefined) ? "" : String(s); }

  // ---- Read payload ?p= (preferred from visor) ----
  var p = qs("p");
  if (p) {
    try {
      var payload = JSON.parse(decodeURIComponent(p));
      // The visor sends dataUrl, dims, meta (min/max/unit/palette), title/subtitle.
      setIf("mapUrl", payload.dataUrl || payload.mapUrl || payload.map);
      setIf("title", payload.title);
      // Build a helpful subtitle if none provided
      var sub = payload.subtitle || "";
      if (!sub && payload.meta) {
        var m = payload.meta;
        var parts = [];
        if (m.mode) parts.push(m.mode);
        if (m.map) parts.push(m.map);
        if (m.island) parts.push(m.island);
        if (m.date) parts.push(m.date);
        sub = parts.join(" · ");
      }
      setIf("subtitle", sub);
      if (payload.meta) {
        setIf("vmin", payload.meta.min);
        setIf("vmax", payload.meta.max);
        setIf("unit", payload.meta.unit);
        if (payload.meta.palette && payload.meta.palette.length) {
          setIf("palette", payload.meta.palette.join(","));
        }
      }
    } catch(e) {
      // ignore, fall back to classic params
    }
  }

  // ---- Classic params fallback ----
  setIf("mapUrl", qs("map"));
  setIf("title", qs("title"));
  setIf("subtitle", qs("subtitle"));
  setIf("vmin", qs("min"));
  setIf("vmax", qs("max"));
  setIf("unit", qs("unit"));
  setIf("palette", qs("palette"));
  setIf("scaleKm", qs("scalekm"));
  setIf("brand", qs("brand"));
  setIf("footer", qs("footer"));

  var canvas = document.getElementById("c");
  var ctx = canvas.getContext("2d");
  var errEl = document.getElementById("err");

  function clearErr(){ errEl.textContent = ""; }
  function setErr(s){ errEl.textContent = s || ""; }

  function drawRoundedRect(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawNorthArrow(x, y, size){
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -size);
    ctx.lineTo(size*0.55, size*0.8);
    ctx.lineTo(0, size*0.45);
    ctx.lineTo(-size*0.55, size*0.8);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.moveTo(0, -size*0.72);
    ctx.lineTo(size*0.25, size*0.45);
    ctx.lineTo(0, size*0.25);
    ctx.lineTo(-size*0.25, size*0.45);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#111";
    ctx.font = "600 " + Math.round(size*0.7) + "px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText("N", 0, -size*1.05);
    ctx.restore();
  }

  function drawDroplet(x, y, h){
    var w = h * 0.72;
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -h*0.5);
    ctx.bezierCurveTo(w*0.55, -h*0.3, w*0.55, h*0.15, 0, h*0.5);
    ctx.bezierCurveTo(-w*0.55, h*0.15, -w*0.55, -h*0.3, 0, -h*0.5);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function parsePalette(s){
    if(!s) return ["#440154","#3b528b","#21918c","#5ec962","#fde725"];
    return String(s).split(",").map(function(x){
      x = (x||"").trim().replace("#","");
      if(!x) return null;
      if(x.length===3) x = x[0]+x[0]+x[1]+x[1]+x[2]+x[2];
      return "#"+x;
    }).filter(Boolean);
  }

  function drawLegend(x,y,w,h, vmin, vmax, unit, palette){
    ctx.save();
    ctx.globalAlpha = 0.96;
    ctx.fillStyle = "#fff";
    drawRoundedRect(x,y,w,h,18);
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = "rgba(0,0,0,0.08)";
    ctx.lineWidth = 2;
    drawRoundedRect(x,y,w,h,18);
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = "700 20px system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText(unit || "Llegenda", x+16, y+14);

    var barX = x+16, barY = y+46, barW = w-32, barH = 18;
    var grad = ctx.createLinearGradient(barX,0,barX+barW,0);
    var stops = palette.length-1;
    for(var i=0;i<palette.length;i++){
      grad.addColorStop(stops ? (i/stops) : 0, palette[i]);
    }
    ctx.fillStyle = grad;
    drawRoundedRect(barX, barY, barW, barH, 9);
    ctx.fill();

    ctx.fillStyle = "#333";
    ctx.font = "600 14px system-ui, sans-serif";
    ctx.textBaseline = "top";
    ctx.fillText(sanitize(vmin), barX, barY+barH+10);
    ctx.textAlign = "right";
    ctx.fillText(sanitize(vmax), barX+barW, barY+barH+10);
    ctx.restore();
  }

  function drawScaleBar(x, y, widthPx, label){
    ctx.save();
    ctx.fillStyle = "#111";
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x+widthPx, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y-8); ctx.lineTo(x, y+8);
    ctx.moveTo(x+widthPx, y-8); ctx.lineTo(x+widthPx, y+8);
    ctx.stroke();
    ctx.font = "700 14px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText(label, x+widthPx/2, y-10);
    ctx.restore();
  }

  function render(){
    clearErr();

    var mapUrl = document.getElementById("mapUrl").value.trim();
    if(!mapUrl){ setErr("Falta l'URL del mapa (mapUrl)."); return; }

    var title = document.getElementById("title").value.trim();
    var subtitle = document.getElementById("subtitle").value.trim();
    var vmin = document.getElementById("vmin").value.trim();
    var vmax = document.getElementById("vmax").value.trim();
    var unit = document.getElementById("unit").value.trim();
    var palette = parsePalette(document.getElementById("palette").value);
    var scaleKm = document.getElementById("scaleKm").value.trim();
    var brand = document.getElementById("brand").value.trim() || "Càtedra de la Insularitat";
    var footer = document.getElementById("footer").value.trim();

    var W = canvas.width, H = canvas.height;
    var pad = 60;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    var img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = function(){
      // Header band
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,140);
      ctx.strokeStyle = "rgba(0,0,0,0.06)";
      ctx.beginPath(); ctx.moveTo(0,140); ctx.lineTo(W,140); ctx.stroke();

      drawDroplet(pad, 70, 44);
      ctx.fillStyle = "#111";
      ctx.font = "800 22px system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(brand, pad+42, 70);

      ctx.fillStyle = "#111";
      ctx.font = "900 28px system-ui, sans-serif";
      ctx.textBaseline = "top";
      ctx.fillText(title || "Pòster", pad, 150);

      ctx.font = "600 16px system-ui, sans-serif";
      ctx.fillStyle = "#333";
      var lines = subtitle ? subtitle.split("\n").slice(0,3) : [];
      for(var i=0;i<lines.length;i++){
        ctx.fillText(lines[i], pad, 188 + i*20);
      }

      // Map frame region
      var mapTop = 240;
      var mapX = pad;
      var mapY = mapTop;
      var mapW = W - pad*2;
      var mapH = H - mapTop - 120;

      // aspect fit
      var ar = img.width / img.height;
      var targetAr = mapW / mapH;
      var drawW, drawH, dx, dy;
      if(ar > targetAr){
        drawW = mapW;
        drawH = mapW / ar;
        dx = mapX;
        dy = mapY + (mapH - drawH)/2;
      } else {
        drawH = mapH;
        drawW = mapH * ar;
        dx = mapX + (mapW - drawW)/2;
        dy = mapY;
      }

      ctx.fillStyle = "#fff";
      drawRoundedRect(mapX, mapY, mapW, mapH, 22);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.10)";
      ctx.lineWidth = 2;
      drawRoundedRect(mapX, mapY, mapW, mapH, 22);
      ctx.stroke();

      ctx.save();
      drawRoundedRect(mapX, mapY, mapW, mapH, 22);
      ctx.clip();
      ctx.drawImage(img, dx, dy, drawW, drawH);
      ctx.restore();

      drawNorthArrow(mapX + mapW - 70, mapY + 85, 26);

      if(scaleKm){
        var km = Number(scaleKm);
        if(isFinite(km) && km>0){
          var scalepx = Number(qs("scalepx") || 180);
          if(!isFinite(scalepx) || scalepx<=0) scalepx = 180;
          drawScaleBar(mapX + 28, mapY + mapH - 28, scalepx, km + " km");
        }
      }

      // Legend card
      var legW = 420, legH = 110;
      var legX = mapX + mapW - legW - 22;
      var legY = mapY + mapH - legH - 22;
      drawLegend(legX, legY, legW, legH, vmin, vmax, unit, palette);

      // Footer
      ctx.fillStyle = "#444";
      ctx.font = "600 13px system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(footer || "", pad, H - 40);

      ctx.textAlign = "right";
      ctx.fillStyle = "#777";
      ctx.fillText("Generat amb GEE Poster Composer", W - pad, H - 40);
    };

    img.onerror = function(){
      setErr("No s'ha pogut carregar el PNG del mapa.\n\n- Revisa que l'URL sigui correcte.\n- Pot ser CORS.\n\nProva d'obrir el dataUrl directament en una pestanya nova: si no es veu, l'URL és invàlid o ha expirat.");
    };

    img.src = mapUrl;
  }

  function download(){
    clearErr();
    try{
      var a = document.createElement("a");
      a.download = "poster.png";
      a.href = canvas.toDataURL("image/png");
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch(e){
      setErr("No s'ha pogut exportar el canvas a PNG.\n\nAixò sol ser 'tainted canvas' per CORS.\nDetall:\n" + e);
    }
  }

  document.getElementById("btnRender").addEventListener("click", render);
  document.getElementById("btnDownload").addEventListener("click", download);

  // Auto-render if payload exists
  if (qs("p") || qs("map")) setTimeout(render, 50);
})();
</script>
</body>
</html>

