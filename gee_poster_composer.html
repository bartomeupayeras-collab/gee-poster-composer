<!DOCTYPE html>

<html lang="ca">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Compositor de pòster (GEE)</title>
<style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111; }
    header { padding: 14px 16px; background:#fff; border-bottom:1px solid #e6e8f0; position:sticky; top:0; z-index:5; }
    header h1 { font-size: 16px; margin:0; }
    header .sub { font-size: 12px; color:#444; margin-top:4px; }
    main { padding: 14px 16px; display:grid; grid-template-columns: 360px 1fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){ main{ grid-template-columns: 1fr; } }
    .card { background:#fff; border:1px solid #e6e8f0; border-radius: 14px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { font-size: 12px; color:#333; display:block; margin: 10px 0 6px; }
    input, textarea { width:100%; box-sizing:border-box; border:1px solid #d8dbe6; border-radius: 10px; padding: 10px; font-size: 13px; background:#fff; }
    textarea { min-height: 68px; resize: vertical; }
    button { border:0; border-radius: 12px; padding: 10px 12px; font-weight: 700; cursor:pointer; }
    button.primary { background:#111; color:#fff; }
    button.secondary { background:#eef1f8; color:#111; }
    .hint { font-size: 12px; color:#555; margin-top: 8px; line-height: 1.35; }
    .err { color:#b00020; font-size: 12px; margin-top: 8px; white-space: pre-wrap; }
    canvas { width:100%; height:auto; background:#fff; border:1px solid #e6e8f0; border-radius: 14px; }
    .tiny { font-size:11px; color:#666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 11px; }
  </style>
</head>
<body>
<header>
<h1>Compositor de pòster (GEE)</h1>
<div class="sub">Obre'l des del visor. Compatible amb <span class="mono">?p=</span> (payload) o amb paràmetres clàssics (<span class="mono">?map=</span>).</div>
</header>
<main>
<section class="card">
<div class="row">
<button class="primary" id="btnRender">Generar / Actualitzar</button>
<button class="secondary" id="btnDownload">Descarregar PNG</button>
</div>
<div class="hint">
      Des del visor, l'enllaç sol venir com <span class="mono">?p=...</span> (payload). Si vols provar manualment:
      <span class="mono">?map=&lt;MAP_URL&gt;&amp;title=...&amp;subtitle=...&amp;min=...&amp;max=...&amp;unit=...</span>
</div>
<label>URL del mapa (PNG) *</label>
<input id="mapUrl" placeholder="getThumbURL del mapa base (PNG)"/>
<label>Títol</label>
<input id="title" placeholder="Ex: Comparador insular"/>
<label>Subtítol (1–3 línies)</label>
<textarea id="subtitle" placeholder="Ex: Variable · Mode · Data"></textarea>
<div class="row">
<div style="flex:1">
<label>Min</label>
<input id="vmin" placeholder="Ex: 0.12"/>
</div>
<div style="flex:1">
<label>Max</label>
<input id="vmax" placeholder="Ex: 0.78"/>
</div>
<div style="flex:1">
<label>Unitat</label>
<input id="unit" placeholder="Ex: NDVI"/>
</div>
</div>
<label>Paleta (hex separats per coma)</label>
<input id="palette" placeholder="Ex: 440154,3b528b,21918c,5ec962,fde725"/>
<div class="row">
<div style="flex:1">
<label>Escala (km)</label>
<input id="scaleKm" placeholder="Ex: 50"/>
</div>
<div style="flex:1">
<label>Nom marca</label>
<input id="brand" placeholder="Càtedra de la Insularitat"/>
</div>
</div>
<label>Peu</label>
<input id="footer" placeholder="Ex: GEE · Copernicus · Consell Insular"/>
<div class="tiny" style="margin-top:10px;">
      Si el mapa no carrega o la descàrrega falla, sol ser CORS. Solució: afegir proxy o carregar PNG local (es pot afegir si ho necessites).
    </div>
<div class="err" id="err"></div>
</section>
<section class="card">
<canvas height="1600" id="c" width="2400"></canvas>
</section>
</main>
<script>(function(){
  function qs(k){ return new URLSearchParams(location.search).get(k); }
  function setIf(id, v){ if(v!==null && v!==undefined && v!==""){ document.getElementById(id).value = v; } }
  function sanitize(s){ return (s===null||s===undefined) ? "" : String(s); }

  // ---- Robust payload decoding ----
  function safeDecode(s){
    let out = String(s ?? "");
    // URLSearchParams.get() already decodes %xx, but payloads can arrive double-encoded.
    // Also guard '+' being used as space.
    out = out.replace(/\+/g, "%20");
    for(let i=0;i<3;i++){
      try{
        const dec = decodeURIComponent(out);
        if(dec === out) break;
        out = dec;
      }catch(_e){ break; }
    }
    return out;
  }
  function safeJSONParse(s){
    const raw = String(s ?? "");
    // Optional: base64url payload ?p=b64:<...>
    if(raw.startsWith("b64:")){
      try{
        const b64 = raw.slice(4).replace(/-/g, "+").replace(/_/g, "/");
        const pad = b64.length % 4 ? "=".repeat(4 - (b64.length % 4)) : "";
        const jsonStr = atob(b64 + pad);
        return JSON.parse(jsonStr);
      }catch(_e){ /* fall through */ }
    }
    try{ return JSON.parse(raw); }catch(_e1){
      try{ return JSON.parse(safeDecode(raw)); }catch(_e2){
        try{
          const unescaped = safeDecode(raw).replace(/&quot;/g,'"').replace(/&#34;/g,'"');
          return JSON.parse(unescaped);
        }catch(_e3){
          return null;
        }
      }
    }
  }

  // Keep bbox/dims from payload for real scale if available
  let initialBBox = null; // [W,S,E,N] in EPSG:4326
  let initialDims = null; // {w,h} in pixels of the map image that bbox refers to

  // ---- Read payload ?p= (preferred from visor) ----
  var p = qs("p");
  if (p) {
    try {
      var payload = safeJSONParse(p) || {};
      // The visor sends dataUrl, dims, bbox, meta (min/max/unit/palette), title/subtitle.
      setIf("mapUrl", payload.dataUrl || payload.mapUrl || payload.map || payload.url);
      setIf("title", payload.title);

      if(payload.bbox) initialBBox = payload.bbox;
      if(payload.dims) initialDims = payload.dims;

      // Build a helpful subtitle if none provided
      var sub = payload.subtitle || "";
      if (!sub && payload.meta) {
        var m = payload.meta;
        var parts = [];
        if (m.mode) parts.push(m.mode);
        if (m.map) parts.push(m.map);
        if (m.island) parts.push(m.island);
        if (m.isla) parts.push(m.isla);
        if (m.date) parts.push(m.date);
        sub = parts.join(" · ");
      }
      setIf("subtitle", sub);

      if (payload.meta) {
        setIf("vmin", payload.meta.min);
        setIf("vmax", payload.meta.max);
        setIf("unit", payload.meta.unit);
        if (payload.meta.palette && payload.meta.palette.length) {
          setIf("palette", payload.meta.palette.join(","));
        }
        // If visor provides a suggested scale km, accept it
        if(payload.meta.scaleKm) setIf("scaleKm", payload.meta.scaleKm);
      }
    } catch(e) {
      // ignore, fall back to classic params
    }
  }

  // ---- Classic params fallback ----
  setIf("mapUrl", qs("map"));
  setIf("title", qs("title"));
  setIf("subtitle", qs("subtitle"));
  setIf("vmin", qs("min"));
  setIf("vmax", qs("max"));
  setIf("unit", qs("unit"));
  setIf("palette", qs("palette"));
  setIf("scaleKm", qs("scalekm"));
  setIf("brand", qs("brand"));
  setIf("footer", qs("footer"));

  var canvas = document.getElementById("c");
  var ctx = canvas.getContext("2d", { willReadFrequently: true });
  var errEl = document.getElementById("err");

  function clearErr(){ errEl.textContent = ""; }
  function setErr(s){ errEl.textContent = s || ""; }

  function drawRoundedRect(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawNorthArrow(x, y, size){
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -size);
    ctx.lineTo(size*0.55, size*0.8);
    ctx.lineTo(0, size*0.45);
    ctx.lineTo(-size*0.55, size*0.8);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.moveTo(0, -size*0.72);
    ctx.lineTo(size*0.25, size*0.45);
    ctx.lineTo(0, size*0.25);
    ctx.lineTo(-size*0.25, size*0.45);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "#111";
    ctx.font = "600 " + Math.round(size*0.7) + "px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText("N", 0, -size*1.05);
    ctx.restore();
  }

  function drawDroplet(x, y, h){
    var w = h * 0.72;
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -h*0.5);
    ctx.bezierCurveTo(w*0.55, -h*0.3, w*0.55, h*0.15, 0, h*0.5);
    ctx.bezierCurveTo(-w*0.55, h*0.15, -w*0.55, -h*0.3, 0, -h*0.5);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function parsePalette(s){
    const fallback = ["#440154","#3b528b","#21918c","#5ec962","#fde725"];
    if(!s) return fallback;
    const out = [];
    String(s).split(",").forEach(function(x){
      x = (x||"").trim().replace("#","");
      if(!x) return;
      if(x.length===3) x = x[0]+x[0]+x[1]+x[1]+x[2]+x[2];
      if(!/^[0-9a-fA-F]{6}$/.test(x)) return; // validate real hex
      out.push("#"+x.toLowerCase());
    });
    return out.length ? out : fallback;
  }

  function drawLegend(x,y,w,h, vmin, vmax, unit, palette){
    ctx.save();
    ctx.globalAlpha = 0.96;
    ctx.fillStyle = "#fff";
    drawRoundedRect(x,y,w,h,18);
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = "rgba(0,0,0,0.08)";
    ctx.lineWidth = 2;
    drawRoundedRect(x,y,w,h,18);
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = "700 20px system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText(unit || "Llegenda", x+16, y+14);

    var barX = x+16, barY = y+46, barW = w-32, barH = 18;
    var grad = ctx.createLinearGradient(barX,0,barX+barW,0);
    var stops = Math.max(1, palette.length-1);
    for(var i=0;i<palette.length;i++){
      grad.addColorStop(i/stops, palette[i]);
    }
    ctx.fillStyle = grad;
    drawRoundedRect(barX, barY, barW, barH, 9);
    ctx.fill();

    // Bigger numbers for readability
    ctx.fillStyle = "#333";
    ctx.font = "700 16px system-ui, sans-serif";
    ctx.textBaseline = "top";
    ctx.textAlign = "left";
    ctx.fillText(sanitize(vmin), barX, barY+barH+10);
    ctx.textAlign = "right";
    ctx.fillText(sanitize(vmax), barX+barW, barY+barH+10);
    ctx.restore();
  }

  function drawScaleBar(x, y, widthPx, label){
    ctx.save();
    ctx.fillStyle = "#111";
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x+widthPx, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y-10); ctx.lineTo(x, y+10);
    ctx.moveTo(x+widthPx, y-10); ctx.lineTo(x+widthPx, y+10);
    ctx.stroke();
    ctx.font = "800 16px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText(label, x+widthPx/2, y-12);
    ctx.restore();
  }

  // Approx geodesic distance (km) between lon/lat points (haversine)
  function haversineKm(lon1, lat1, lon2, lat2){
    function rad(d){ return d*Math.PI/180; }
    const R = 6371.0088;
    const dLat = rad(lat2-lat1);
    const dLon = rad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(rad(lat1))*Math.cos(rad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.min(1, Math.sqrt(a)));
  }

  function computeScalePxFromBBox(desiredKm){
    // If bbox + dims exist, compute km per px across bbox width at mid-lat
    try{
      if(!initialBBox || !initialDims) return null;
      const W = Number(initialBBox[0]), S = Number(initialBBox[1]), E = Number(initialBBox[2]), N = Number(initialBBox[3]);
      const imgW = Number(initialDims.w);
      if(!isFinite(W)||!isFinite(S)||!isFinite(E)||!isFinite(N)||!isFinite(imgW) || imgW<=0) return null;
      const midLat = (S+N)/2;
      const kmWidth = haversineKm(W, midLat, E, midLat);
      if(!isFinite(kmWidth) || kmWidth<=0) return null;
      const kmPerPx = kmWidth / imgW;
      if(!isFinite(kmPerPx) || kmPerPx<=0) return null;
      const px = desiredKm / kmPerPx;
      if(!isFinite(px) || px<=0) return null;
      return px;
    }catch(_e){
      return null;
    }
  }

  function render(){
    clearErr();

    var mapUrl = document.getElementById("mapUrl").value.trim();
    if(!mapUrl){ setErr("Falta l'URL del mapa (mapUrl)."); return; }

    var title = document.getElementById("title").value.trim();
    var subtitle = document.getElementById("subtitle").value.trim();
    var vmin = document.getElementById("vmin").value.trim();
    var vmax = document.getElementById("vmax").value.trim();
    var unit = document.getElementById("unit").value.trim();
    var palette = parsePalette(document.getElementById("palette").value);
    var scaleKm = document.getElementById("scaleKm").value.trim();
    var brand = document.getElementById("brand").value.trim() || "Càtedra de la Insularitat";
    var footer = document.getElementById("footer").value.trim();

    var Wc = canvas.width, Hc = canvas.height;
    var pad = 60;

    ctx.clearRect(0,0,Wc,Hc);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,Wc,Hc);

    var img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = function(){
      // Header band
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,Wc,140);
      ctx.strokeStyle = "rgba(0,0,0,0.06)";
      ctx.beginPath(); ctx.moveTo(0,140); ctx.lineTo(Wc,140); ctx.stroke();

      drawDroplet(pad, 70, 44);
      ctx.fillStyle = "#111";
      ctx.font = "800 22px system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(brand, pad+42, 70);

      ctx.fillStyle = "#111";
      ctx.font = "900 28px system-ui, sans-serif";
      ctx.textBaseline = "top";
      ctx.fillText(title || "Pòster", pad, 150);

      ctx.font = "600 16px system-ui, sans-serif";
      ctx.fillStyle = "#333";
      var lines = subtitle ? subtitle.split("\n").slice(0,3) : [];
      for(var i=0;i<lines.length;i++){
        ctx.fillText(lines[i], pad, 188 + i*20);
      }

      // Map frame region
      var mapTop = 240;
      var mapX = pad;
      var mapY = mapTop;
      var mapW = Wc - pad*2;
      var mapH = Hc - mapTop - 120;

      // aspect fit
      var ar = img.width / img.height;
      var targetAr = mapW / mapH;
      var drawW, drawH, dx, dy;
      if(ar > targetAr){
        drawW = mapW;
        drawH = mapW / ar;
        dx = mapX;
        dy = mapY + (mapH - drawH)/2;
      } else {
        drawH = mapH;
        drawW = mapH * ar;
        dx = mapX + (mapW - drawW)/2;
        dy = mapY;
      }

      ctx.fillStyle = "#fff";
      drawRoundedRect(mapX, mapY, mapW, mapH, 22);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.10)";
      ctx.lineWidth = 2;
      drawRoundedRect(mapX, mapY, mapW, mapH, 22);
      ctx.stroke();

      ctx.save();
      drawRoundedRect(mapX, mapY, mapW, mapH, 22);
      ctx.clip();
      ctx.drawImage(img, dx, dy, drawW, drawH);
      ctx.restore();

      drawNorthArrow(mapX + mapW - 70, mapY + 85, 26);

      // Scale: if bbox/dims exist -> real; else fallback to fixed px
      if(scaleKm){
        var km = Number(scaleKm);
        if(isFinite(km) && km>0){
          var realPx = computeScalePxFromBBox(km);
          var scalepx = realPx;
          if(!scalepx){
            scalepx = Number(qs("scalepx") || 220);
          }
          // Clamp to sensible range
          if(!isFinite(scalepx) || scalepx<=0) scalepx = 220;
          scalepx = Math.max(120, Math.min(scalepx, mapW*0.45));
          drawScaleBar(mapX + 28, mapY + mapH - 28, scalepx, km + " km");
        }
      }

      // Legend card
      var legW = 440, legH = 120;
      var legX = mapX + mapW - legW - 22;
      var legY = mapY + mapH - legH - 22;
      drawLegend(legX, legY, legW, legH, vmin, vmax, unit, palette);

      // Footer
      ctx.fillStyle = "#444";
      ctx.font = "600 13px system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(footer || "", pad, Hc - 40);

      ctx.textAlign = "right";
      ctx.fillStyle = "#777";
      ctx.fillText("Generat amb GEE Poster Composer", Wc - pad, Hc - 40);
    };

    img.onerror = function(){
      setErr(
        "No s'ha pogut carregar el PNG del mapa.\n\n" +
        "- Revisa que l'URL sigui correcte o que no hagi expirat.\n" +
        "- Si al navegador es veu però aquí falla, pot ser CORS.\n\n" +
        "Tip: prova d'obrir el mapUrl en una pestanya nova."
      );
    };

    img.src = mapUrl;
  }

  function canvasReadable(){
    try{
      // If canvas is tainted due to CORS, this throws
      ctx.getImageData(0,0,1,1);
      return true;
    }catch(_e){
      return false;
    }
  }

  function download(){
    clearErr();
    if(!canvasReadable()){
      setErr(
        "No s'ha pogut exportar el PNG perquè el canvas està 'tainted' (CORS).\n\n" +
        "Això passa si el PNG del mapa (getThumbURL) no envia capçalera Access-Control-Allow-Origin.\n" +
        "Solució típica: servir el PNG via proxy amb CORS o generar el pòster dins el mateix domini.\n\n" +
        "Mentrestant: obre el mapUrl en una pestanya i guarda el PNG base."
      );
      return;
    }

    // Prefer toBlob (more memory-friendly). Fallback toDataURL.
    try{
      canvas.toBlob(function(blob){
        if(!blob){
          try{
            var a = document.createElement("a");
            a.download = "poster.png";
            a.href = canvas.toDataURL("image/png");
            document.body.appendChild(a);
            a.click();
            a.remove();
          }catch(e2){
            setErr("No s'ha pogut exportar el canvas a PNG.\nDetall:\n" + e2);
          }
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.download = "poster.png";
        a.href = url;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
      }, "image/png");
    }catch(e){
      setErr("No s'ha pogut exportar el canvas a PNG.\nDetall:\n" + e);
    }
  }

  document.getElementById("btnRender").addEventListener("click", render);
  document.getElementById("btnDownload").addEventListener("click", download);

  // Auto-render if payload exists
  if (qs("p") || qs("map")) setTimeout(render, 50);
})();</script>
</body>
</html>
