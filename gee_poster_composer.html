<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InsuLab Poster Composer</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e6e8f0;
      --text:#111;
      --muted:#4b5563;
      --muted2:#6b7280;
      --brand:#111;
      --soft:#eef1f8;
      --danger:#b00020;
      --radius:16px;
      --shadow: 0 8px 30px rgba(0,0,0,0.06);
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width: 1320px; margin:0 auto; padding: 14px 16px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap:14px;
    }
    .logos{
      display:flex; align-items:center; gap:14px;
      padding: 6px 10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    }
    .logos img{
      display:block;
      height:40px;
      width:auto;
      object-fit:contain;
    }
    h1{ font-size:15px; margin:0; letter-spacing:.2px; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:0; border-radius: 14px;
      padding: 10px 12px; font-weight: 800; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    button.primary{ background:var(--brand); color:#fff; }
    button.secondary{ background:var(--soft); color:var(--text); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    main .grid{
      display:grid;
      grid-template-columns: 400px 1fr;
      gap:14px;
      align-items:start;
      padding: 14px 16px;
      max-width: 1320px;
      margin:0 auto;
    }
    @media (max-width: 980px){
      main .grid{ grid-template-columns: 1fr; }
      .logos img{ height:34px; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .pad{ padding: 12px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:12px; color:#374151; display:block; margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      border:1px solid #d8dbe6;
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      background:#fff;
    }
    textarea{ min-height: 70px; resize:vertical; }

    details{
      border-top:1px solid var(--line);
      background: #fbfbfe;
    }
    details summary{
      list-style:none;
      cursor:pointer;
      padding: 12px;
      font-weight: 800;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:space-between;
      user-select:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    details .pad{ padding: 12px; }

    .tog{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background:#fff;
      font-size:12px;
      color:#111;
      user-select:none;
    }
    .pill input{ width:auto; margin:0; }

    .err{
      color:var(--danger);
      font-size:12px;
      white-space:pre-wrap;
      border-top:1px solid var(--line);
      background:#fff5f7;
      padding: 10px 12px;
      display:none;
    }
    .ok{
      font-size:12px;
      color: var(--muted2);
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .canvasWrap{
      padding: 12px;
      height: calc(100vh - 120px);
      min-height: 520px;
    }
    canvas{
      width:100%;
      height:100%;
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--radius);
      display:block;
    }

    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:11px; }
    .spin{
      display:inline-block;
      width:14px; height:14px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,0.15);
      border-top-color: rgba(0,0,0,0.7);
      animation: r 0.7s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes r{ to{ transform:rotate(360deg);} }

    .langbar{
      display:flex; gap:8px; align-items:center;
      padding: 6px;
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    }
    .langbtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
    }
    .langbtn.active{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logos" aria-label="Logos">
          <img src="338690_logo-uib-horizontal300.png" alt="UIB" />
          <img src="GOVERN_IB_H_2_COL.png" alt="GOIB" />
        </div>
        <div>
          <h1>InsuLab · Càtedra de la Insularitat</h1>
        </div>
      </div>

      <div class="btns">
        <div class="langbar" title="Idioma">
          <button class="langbtn" data-lang="ca">CA</button>
          <button class="langbtn" data-lang="es">ES</button>
          <button class="langbtn" data-lang="en">EN</button>
        </div>
        <button class="secondary" id="btnReset" data-i18n="btn_reload" title="Recarregar valors del payload">Recarregar</button>
        <button class="primary" id="btnRender" data-i18n="btn_generate">Generar</button>
        <button class="secondary" id="btnDownload" data-i18n="btn_download">Descarregar PNG</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="pad">

        <label data-i18n="lbl_map">Mapa (PNG) *</label>
        <input id="mapUrl" data-i18n-placeholder="ph_map" placeholder="getThumbURL del mapa base (PNG)" />

        <div class="row">
          <div style="flex:1">
            <label data-i18n="lbl_width">Amplada pòster</label>
            <select id="posterW">
              <option value="2400">2400 px</option>
              <option value="3200" selected>3200 px</option>
              <option value="4000">4000 px</option>
            </select>
          </div>
          <div style="flex:1">
            <label data-i18n="lbl_pad">Marge intern</label>
            <select id="padPx">
              <option value="44" data-i18n="opt_compact">Compacte</option>
              <option value="60" selected data-i18n="opt_normal">Normal</option>
              <option value="78" data-i18n="opt_airy">Airejat</option>
            </select>
          </div>
        </div>

        <div class="tog">
          <label class="pill"><input type="checkbox" id="showLegend" checked> <span data-i18n="tog_legend">Llegenda</span></label>
          <label class="pill"><input type="checkbox" id="showNorth" checked> <span data-i18n="tog_north">Nord</span></label>
          <label class="pill"><input type="checkbox" id="showScale" checked> <span data-i18n="tog_scale">Escala</span></label>
          <label class="pill"><input type="checkbox" id="showFooter" checked> <span data-i18n="tog_footer">Peu</span></label>
        </div>

        <div class="ok">
          <div id="status"></div>
          <div class="mono" id="fn"></div>
        </div>
      </div>

      <details id="adv" open>
        <summary>
          <span data-i18n="adv_title">Detalls (avançat)</span>
          <span class="mono" data-i18n="adv_meta">títol · llegenda</span>
        </summary>
        <div class="pad">
          <label data-i18n="lbl_title">Títol</label>
          <input id="title" data-i18n-placeholder="ph_title" placeholder="Ex: Comparador insular" />

          <label data-i18n="lbl_subtitle">Subtítol (1–3 línies)</label>
          <textarea id="subtitle" data-i18n-placeholder="ph_subtitle" placeholder="Ex: Variable · Mode · Any"></textarea>

          <div class="row">
            <div style="flex:1">
              <label data-i18n="lbl_min">Min</label>
              <input id="vmin" data-i18n-placeholder="ph_min" placeholder="Ex: 0.12" />
            </div>
            <div style="flex:1">
              <label data-i18n="lbl_max">Max</label>
              <input id="vmax" data-i18n-placeholder="ph_max" placeholder="Ex: 0.78" />
            </div>
            <div style="flex:1">
              <label data-i18n="lbl_unit">Unitat</label>
              <input id="unit" data-i18n-placeholder="ph_unit" placeholder="Ex: NDVI / °C / mm" />
            </div>
          </div>

          <label data-i18n="lbl_palette">Paleta (hex separats per coma)</label>
          <input id="palette" data-i18n-placeholder="ph_palette" placeholder="440154,3b528b,21918c,5ec962,fde725" />

          <div class="row">
            <div style="flex:1">
              <label data-i18n="lbl_scale_km">Escala (km) (si activada)</label>
              <input id="scaleKm" data-i18n-placeholder="ph_scale_km" placeholder="Ex: 50" />
            </div>
            <div style="flex:1">
              <label data-i18n="lbl_scale_px">Amplada escala (px)</label>
              <input id="scalePx" data-i18n-placeholder="ph_scale_px" placeholder="Ex: 220" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label data-i18n="lbl_footer">Peu</label>
              <input id="footer" data-i18n-placeholder="ph_footer" placeholder="Ex: GEE · Copernicus · Consell Insular" />
            </div>
          </div>

          <div class="hint" style="margin-top:10px" data-i18n="hint_cors">
            Si la descàrrega falla, gairebé sempre és <b>CORS</b> (canvas “tainted”).
            En aquest cas, el PNG del mapa no es pot llegir dins el canvas.
          </div>
        </div>
      </details>

      <div class="err" id="err"></div>
    </section>

    <section class="card">
      <div class="canvasWrap">
        <canvas id="c" width="2400" height="1600"></canvas>
      </div>
    </section>
  </div>
</main>

<script>
(() => {
  const I18N = {
    ca: {
      btn_reload: "Recarregar",
      btn_generate: "Generar",
      btn_download: "Descarregar PNG",
      lbl_map: "Mapa (PNG) *",
      ph_map: "getThumbURL del mapa base (PNG)",
      lbl_width: "Amplada pòster",
      lbl_pad: "Marge intern",
      opt_compact: "Compacte",
      opt_normal: "Normal",
      opt_airy: "Airejat",
      tog_legend: "Llegenda",
      tog_north: "Nord",
      tog_scale: "Escala",
      tog_footer: "Peu",
      adv_title: "Detalls (avançat)",
      adv_meta: "títol · llegenda",
      lbl_title: "Títol",
      ph_title: "Ex: Comparador insular",
      lbl_subtitle: "Subtítol (1–3 línies)",
      ph_subtitle: "Ex: Variable · Mode · Any",
      lbl_min: "Min",
      ph_min: "Ex: 0.12",
      lbl_max: "Max",
      ph_max: "Ex: 0.78",
      lbl_unit: "Unitat",
      ph_unit: "Ex: NDVI / °C / mm",
      lbl_palette: "Paleta (hex separats per coma)",
      ph_palette: "440154,3b528b,21918c,5ec962,fde725",
      lbl_scale_km: "Escala (km) (si activada)",
      ph_scale_km: "Ex: 50",
      lbl_scale_px: "Amplada escala (px)",
      ph_scale_px: "Ex: 220",
      lbl_footer: "Peu",
      ph_footer: "Ex: GEE · Copernicus · Consell Insular",
      hint_cors: "Si la descàrrega falla, gairebé sempre és <b>CORS</b> (canvas “tainted”). En aquest cas, el PNG del mapa no es pot llegir dins el canvas.",
      generating: "Generant…",
      done: "Fet",
      err_missing_map: "Falta l'URL del mapa (PNG).",
      err_map_load: "No s'ha pogut carregar el PNG del mapa.\n\n• Revisa que l'URL sigui correcte i no hagi expirat.\n• Pot ser CORS: si el navegador bloqueja el PNG, el canvas no pot exportar.\n\nProva d'obrir l'URL del mapa en una pestanya nova: si no es veu, l'URL és invàlid o expirat.",
      generated: "Generat amb InsuLab",
      brand_text: "InsuLab · Càtedra de la Insularitat"
    },
    es: {
      btn_reload: "Recargar",
      btn_generate: "Generar",
      btn_download: "Descargar PNG",
      lbl_map: "Mapa (PNG) *",
      ph_map: "getThumbURL del mapa base (PNG)",
      lbl_width: "Ancho póster",
      lbl_pad: "Margen interno",
      opt_compact: "Compacto",
      opt_normal: "Normal",
      opt_airy: "Aireado",
      tog_legend: "Leyenda",
      tog_north: "Norte",
      tog_scale: "Escala",
      tog_footer: "Pie",
      adv_title: "Detalles (avanzado)",
      adv_meta: "título · leyenda",
      lbl_title: "Título",
      ph_title: "Ej.: Comparador insular",
      lbl_subtitle: "Subtítulo (1–3 líneas)",
      ph_subtitle: "Ej.: Variable · Modo · Año",
      lbl_min: "Mín",
      ph_min: "Ej.: 0.12",
      lbl_max: "Máx",
      ph_max: "Ej.: 0.78",
      lbl_unit: "Unidad",
      ph_unit: "Ej.: NDVI / °C / mm",
      lbl_palette: "Paleta (hex separados por coma)",
      ph_palette: "440154,3b528b,21918c,5ec962,fde725",
      lbl_scale_km: "Escala (km) (si activada)",
      ph_scale_km: "Ej.: 50",
      lbl_scale_px: "Ancho escala (px)",
      ph_scale_px: "Ej.: 220",
      lbl_footer: "Pie",
      ph_footer: "Ej.: GEE · Copernicus · Consell Insular",
      hint_cors: "Si la descarga falla, casi siempre es <b>CORS</b> (canvas “tainted”). En ese caso, el PNG del mapa no se puede leer dentro del canvas.",
      generating: "Generando…",
      done: "Hecho",
      err_missing_map: "Falta la URL del mapa (PNG).",
      err_map_load: "No se ha podido cargar el PNG del mapa.\n\n• Revisa que la URL sea correcta y no haya caducado.\n• Puede ser CORS: si el navegador bloquea el PNG, el canvas no puede exportar.\n\nPrueba a abrir la URL del mapa en una pestaña nueva: si no se ve, la URL es inválida o ha caducado.",
      generated: "Generado con InsuLab",
      brand_text: "InsuLab · Càtedra de la Insularitat"
    },
    en: {
      btn_reload: "Reload",
      btn_generate: "Generate",
      btn_download: "Download PNG",
      lbl_map: "Map (PNG) *",
      ph_map: "Base map getThumbURL (PNG)",
      lbl_width: "Poster width",
      lbl_pad: "Inner margin",
      opt_compact: "Compact",
      opt_normal: "Normal",
      opt_airy: "Airy",
      tog_legend: "Legend",
      tog_north: "North",
      tog_scale: "Scale",
      tog_footer: "Footer",
      adv_title: "Details (advanced)",
      adv_meta: "title · legend",
      lbl_title: "Title",
      ph_title: "e.g., Island comparator",
      lbl_subtitle: "Subtitle (1–3 lines)",
      ph_subtitle: "e.g., Variable · Mode · Year",
      lbl_min: "Min",
      ph_min: "e.g., 0.12",
      lbl_max: "Max",
      ph_max: "e.g., 0.78",
      lbl_unit: "Unit",
      ph_unit: "e.g., NDVI / °C / mm",
      lbl_palette: "Palette (hex comma-separated)",
      ph_palette: "440154,3b528b,21918c,5ec962,fde725",
      lbl_scale_km: "Scale (km) (if enabled)",
      ph_scale_km: "e.g., 50",
      lbl_scale_px: "Scale width (px)",
      ph_scale_px: "e.g., 220",
      lbl_footer: "Footer",
      ph_footer: "e.g., GEE · Copernicus · Consell Insular",
      hint_cors: "If download fails, it’s almost always <b>CORS</b> (a “tainted” canvas). In that case, the map PNG cannot be read inside the canvas.",
      generating: "Generating…",
      done: "Done",
      err_missing_map: "Missing map URL (PNG).",
      err_map_load: "Could not load the map PNG.\n\n• Check the URL and make sure it hasn't expired.\n• It may be CORS: if the browser blocks the PNG, the canvas can't export.\n\nTry opening the map URL in a new tab: if it doesn't display, the URL is invalid or expired.",
      generated: "Generated with InsuLab",
      brand_text: "InsuLab · Càtedra de la Insularitat"
    }
  };

  let LANG = (localStorage.getItem("insulab_lang") || "ca");
  if(!I18N[LANG]) LANG = "ca";
  const t = (k) => (I18N[LANG] && I18N[LANG][k]) ? I18N[LANG][k] : (I18N.ca[k] || k);

  const applyLang = () => {
    document.documentElement.lang = LANG;
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      el.innerHTML = t(key);
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
      const key = el.getAttribute("data-i18n-placeholder");
      el.setAttribute("placeholder", t(key));
    });
    document.querySelectorAll(".langbtn").forEach(b => {
      b.classList.toggle("active", b.dataset.lang === LANG);
    });
  };

  const $ = (id) => document.getElementById(id);
  const qs = (k) => new URLSearchParams(location.search).get(k);
  const sanitize = (s) => (s===null||s===undefined) ? "" : String(s);
  const setIf = (id, v) => { if(v!==null && v!==undefined && v!==""){ $(id).value = v; } };

  const setErr = (msg) => {
    const el = $("err");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  };
  const setStatus = (html) => $("status").innerHTML = html || "";

  const parsePalette = (s) => {
    if(!s) return ["#440154","#3b528b","#21918c","#5ec962","#fde725"];
    return String(s).split(",").map(x=>{
      x = (x||"").trim().replace("#","");
      if(!x) return null;
      if(x.length===3) x = x[0]+x[0]+x[1]+x[1]+x[2]+x[2];
      return "#"+x;
    }).filter(Boolean);
  };

  const slug = (s) => String(s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"_")
    .replace(/^_+|_+$/g,"")
    .slice(0,90) || "poster";

  const drawRoundedRect = (ctx,x,y,w,h,r) => {
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  };

  const drawNorthArrow = (ctx, x, y, size) => {
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -size);
    ctx.lineTo(size*0.55, size*0.8);
    ctx.lineTo(0, size*0.45);
    ctx.lineTo(-size*0.55, size*0.8);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.moveTo(0, -size*0.72);
    ctx.lineTo(size*0.25, size*0.45);
    ctx.lineTo(0, size*0.25);
    ctx.lineTo(-size*0.25, size*0.45);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "#111";
    ctx.font = "800 " + Math.round(size*0.7) + "px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText("N", 0, -size*1.08);
    ctx.restore();
  };

  const drawDroplet = (ctx, x, y, h) => {
    const w = h * 0.72;
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -h*0.5);
    ctx.bezierCurveTo(w*0.55, -h*0.3, w*0.55, h*0.15, 0, h*0.5);
    ctx.bezierCurveTo(-w*0.55, h*0.15, -w*0.55, -h*0.3, 0, -h*0.5);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  };

  const drawLegend = (ctx, x,y,w,h, vmin, vmax, unit, palette, S) => {
    ctx.save();
    ctx.globalAlpha = 0.98;
    ctx.fillStyle = "#fff";
    drawRoundedRect(ctx,x,y,w,h,Math.round(20*S));
    ctx.fill();

    ctx.globalAlpha = 1;
    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.lineWidth = Math.max(2, Math.round(2*S));
    drawRoundedRect(ctx,x,y,w,h,Math.round(20*S));
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = "800 " + Math.round(26*S) + "px system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText(unit || t("tog_legend"), x+Math.round(18*S), y+Math.round(16*S));

    const barX = x+Math.round(18*S), barY = y+Math.round(62*S), barW = w-Math.round(36*S), barH = Math.round(22*S);
    const grad = ctx.createLinearGradient(barX,0,barX+barW,0);
    const stops = Math.max(1, palette.length-1);
    for(let i=0;i<palette.length;i++){
      grad.addColorStop(i/stops, palette[i]);
    }
    ctx.fillStyle = grad;
    drawRoundedRect(ctx,barX,barY,barW,barH,Math.round(11*S));
    ctx.fill();

    ctx.fillStyle = "#333";
    ctx.font = "800 " + Math.round(18*S) + "px system-ui, sans-serif";
    ctx.textBaseline = "top";
    ctx.textAlign = "left";
    ctx.fillText(sanitize(vmin), barX, barY+barH+Math.round(12*S));
    ctx.textAlign = "right";
    ctx.fillText(sanitize(vmax), barX+barW, barY+barH+Math.round(12*S));
    ctx.restore();
  };

  const drawScaleBar = (ctx, x, y, widthPx, label, S) => {
    ctx.save();
    ctx.fillStyle = "#111";
    ctx.strokeStyle = "#111";
    ctx.lineWidth = Math.max(2, Math.round(2*S));
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x+widthPx, y);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(x, y-Math.round(10*S)); ctx.lineTo(x, y+Math.round(10*S));
    ctx.moveTo(x+widthPx, y-Math.round(10*S)); ctx.lineTo(x+widthPx, y+Math.round(10*S));
    ctx.stroke();

    ctx.font = "900 " + Math.round(18*S) + "px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText(label, x+widthPx/2, y-Math.round(12*S));
    ctx.restore();
  };

  let initial = {};
  const loadFromQuery = () => {
    initial = {
      mapUrl: "",
      title: "",
      subtitle: "",
      vmin: "",
      vmax: "",
      unit: "",
      palette: "",
      scaleKm: "",
      scalePx: "",
      footer: "",
      filename: "poster.png"
    };

    const p = qs("p");
    if (p) {
      try{
        const payload = JSON.parse(decodeURIComponent(p));
        initial.mapUrl = payload.dataUrl || payload.thumbUrl || payload.mapUrl || payload.map || payload.url || "";
        initial.title = payload.title || initial.title || "Comparador insular";

        let sub = payload.subtitle || "";
        if(!sub && payload.meta){
          const m = payload.meta;
          const parts = [];
          if (m.mode) parts.push(m.mode);
          if (m.map) parts.push(m.map);
          if (m.island) parts.push(m.island);
          if (m.date) parts.push(m.date);
          sub = parts.join(" · ");
        }
        initial.subtitle = sub;

        if(payload.meta){
          initial.vmin = (payload.meta.min!==null && payload.meta.min!==undefined) ? String(payload.meta.min) : "";
          initial.vmax = (payload.meta.max!==null && payload.meta.max!==undefined) ? String(payload.meta.max) : "";
          initial.unit = payload.meta.unit || "";
          if(Array.isArray(payload.meta.palette)) initial.palette = payload.meta.palette.join(",");
        }

        const f = [
          payload.meta && payload.meta.island ? payload.meta.island : "",
          payload.subtitle || (payload.meta && payload.meta.map ? payload.meta.map : ""),
          payload.meta && payload.meta.date ? payload.meta.date : "",
          payload.meta && payload.meta.mode ? payload.meta.mode : ""
        ].filter(Boolean).join("_");
        initial.filename = slug(f || payload.title || "poster") + ".png";
      }catch(e){}
    }

    if(!initial.mapUrl) initial.mapUrl = qs("map") || "";
    if(!initial.title) initial.title = qs("title") || initial.title;
    if(!initial.subtitle) initial.subtitle = qs("subtitle") || initial.subtitle;
    if(!initial.vmin) initial.vmin = qs("min") || "";
    if(!initial.vmax) initial.vmax = qs("max") || "";
    if(!initial.unit) initial.unit = qs("unit") || "";
    if(!initial.palette) initial.palette = qs("palette") || "";
    initial.scaleKm = qs("scalekm") || "";
    initial.scalePx = qs("scalepx") || "";
    initial.footer = qs("footer") || "";

    setIf("mapUrl", initial.mapUrl);
    setIf("title", initial.title);
    setIf("subtitle", initial.subtitle);
    setIf("vmin", initial.vmin);
    setIf("vmax", initial.vmax);
    setIf("unit", initial.unit);
    setIf("palette", initial.palette);
    setIf("scaleKm", initial.scaleKm);
    setIf("scalePx", initial.scalePx);
    setIf("footer", initial.footer);

    $("fn").textContent = initial.filename || "";
  };

  const canvas = $("c");
  const ctx = canvas.getContext("2d");

  const setCanvasSize = (outW, outH) => {
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    canvas.width = outW * dpr;
    canvas.height = outH * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  };

  const render = () => {
    setErr("");
    $("btnRender").disabled = true;
    setStatus('<span class="spin"></span>' + t("generating"));

    const mapUrl = $("mapUrl").value.trim();
    if(!mapUrl){
      setErr(t("err_missing_map"));
      $("btnRender").disabled = false;
      setStatus("");
      return;
    }

    const posterW = parseInt($("posterW").value, 10) || 3200;
    const pad = parseInt($("padPx").value, 10) || 60;

    const title = $("title").value.trim() || "Poster";
    const subtitle = ($("subtitle").value || "").trim();
    const vmin = $("vmin").value.trim();
    const vmax = $("vmax").value.trim();
    const unit = $("unit").value.trim();
    const palette = parsePalette($("palette").value);
    const scaleKm = $("scaleKm").value.trim();
    let scalePx = parseFloat($("scalePx").value.trim());
    if(!isFinite(scalePx) || scalePx<=0) scalePx = 220;

    const footer = $("footer").value.trim();

    const showLegend = $("showLegend").checked;
    const showNorth  = $("showNorth").checked;
    const showScale  = $("showScale").checked;
    const showFooter = $("showFooter").checked;

    const img = new Image();
    img.crossOrigin = "anonymous";

    img.onload = () => {
      const outW = posterW;
      const outH = Math.round(outW * 0.82);
      setCanvasSize(outW, outH);

      const W = outW, H = outH;
      const S = W / 3200;

      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,H);

      const brandH = Math.round(120*S);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,brandH);
      ctx.strokeStyle = "rgba(0,0,0,0.06)";
      ctx.beginPath(); ctx.moveTo(0,brandH); ctx.lineTo(W,brandH); ctx.stroke();

      drawDroplet(ctx, pad, Math.round(60*S), Math.round(54*S));
      ctx.fillStyle = "#111";
      ctx.font = "900 " + Math.round(28*S) + "px system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(t("brand_text"), pad+Math.round(54*S), Math.round(60*S));

      const titleY = brandH + Math.round(26*S);
      ctx.fillStyle = "#111";
      ctx.font = "950 " + Math.round(54*S) + "px system-ui, sans-serif";
      ctx.textBaseline = "top";
      ctx.fillText(title, pad, titleY);

      const subtitleY = titleY + Math.round(66*S);
      ctx.font = "700 " + Math.round(24*S) + "px system-ui, sans-serif";
      ctx.fillStyle = "#374151";
      const maxLines = 3;
      const lines = subtitle ? subtitle.split("\n").slice(0, maxLines) : [];
      for(let i=0;i<lines.length;i++){
        ctx.fillText(lines[i], pad, subtitleY + i*Math.round(30*S));
      }

      const afterTextGap = Math.round(64*S);
      const mapY = subtitleY + (lines.length ? (lines.length*Math.round(30*S)) : Math.round(10*S)) + afterTextGap;
      const footerH = showFooter ? Math.round(110*S) : Math.round(70*S);

      const mapX = pad;
      const mapW = W - pad*2;
      const mapH = H - mapY - footerH;

      const ar = img.width / img.height;
      const targetAr = mapW / mapH;
      let drawW, drawH, dx, dy;
      if(ar > targetAr){
        drawW = mapW;
        drawH = mapW / ar;
        dx = mapX;
        dy = mapY + (mapH - drawH)/2;
      } else {
        drawH = mapH;
        drawW = mapH * ar;
        dx = mapX + (mapW - drawW)/2;
        dy = mapY;
      }

      ctx.fillStyle = "#fff";
      drawRoundedRect(ctx, mapX, mapY, mapW, mapH, Math.round(26*S));
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.12)";
      ctx.lineWidth = Math.max(2, Math.round(2*S));
      drawRoundedRect(ctx, mapX, mapY, mapW, mapH, Math.round(26*S));
      ctx.stroke();

      ctx.save();
      drawRoundedRect(ctx, mapX, mapY, mapW, mapH, Math.round(26*S));
      ctx.clip();
      ctx.drawImage(img, dx, dy, drawW, drawH);
      ctx.restore();

      if(showNorth){
        drawNorthArrow(ctx, mapX + mapW - Math.round(94*S), mapY + Math.round(120*S), Math.round(34*S));
      }
      if(showScale && scaleKm){
        const km = Number(scaleKm);
        if(isFinite(km) && km>0){
          drawScaleBar(ctx, mapX + Math.round(36*S), mapY + mapH - Math.round(40*S), scalePx, km + " km", S);
        }
      }
      if(showLegend){
        const legW = Math.min(Math.round(620*S), Math.round(mapW * 0.42));
        const legH = Math.round(170*S);
        const legX = mapX + mapW - legW - Math.round(26*S);
        const legY = mapY + mapH - legH - Math.round(26*S);
        drawLegend(ctx, legX, legY, legW, legH, vmin, vmax, unit, palette, S);
      }

      if(showFooter){
        ctx.fillStyle = "#4b5563";
        ctx.font = "650 " + Math.round(18*S) + "px system-ui, sans-serif";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        ctx.fillText(footer || "", pad, H - Math.round(54*S));

        ctx.textAlign = "right";
        ctx.fillStyle = "#9ca3af";
        ctx.fillText(t("generated"), W - pad, H - Math.round(54*S));
      }

      $("btnRender").disabled = false;
      setStatus("✅ " + t("done"));
    };

    img.onerror = () => {
      $("btnRender").disabled = false;
      setStatus("");
      setErr(t("err_map_load"));
    };

    img.src = mapUrl;
  };

  const download = () => {
    setErr("");
    try{
      const name = $("fn").textContent || "poster.png";
      const a = document.createElement("a");
      a.download = name;
      a.href = canvas.toDataURL("image/png");
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){
      setErr("No s'ha pogut exportar el canvas a PNG.\n\nAixò sol ser 'tainted canvas' per CORS.\nDetall:\n" + e);
    }
  };

  $("btnRender").addEventListener("click", render);
  $("btnDownload").addEventListener("click", download);
  $("btnReset").addEventListener("click", () => {
    loadFromQuery();
    setErr("");
    setStatus("");
  });

  document.querySelectorAll(".langbtn").forEach((b)=>{
    b.addEventListener("click", ()=>{
      LANG = b.dataset.lang;
      localStorage.setItem("insulab_lang", LANG);
      applyLang();
      try { render(); } catch(e) {}
    });
  });

  applyLang();
  loadFromQuery();
  if (qs("p") || qs("map")) setTimeout(render, 80);
})();
</script>
</body>
</html>

