<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GEE Poster Composer</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e6e8f0;
      --text:#111;
      --muted:#4b5563;
      --muted2:#6b7280;
      --brand:#111;
      --soft:#eef1f8;
      --danger:#b00020;
      --radius:16px;
      --shadow: 0 8px 30px rgba(0,0,0,0.06);
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width: 1280px; margin:0 auto; padding: 14px 16px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap:10px;
    }
    .mark{
      width:34px; height:34px; border-radius:12px;
      background: var(--brand);
      display:grid; place-items:center; color:#fff; font-weight:900;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      user-select:none;
    }
    h1{ font-size:14px; margin:0; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:0; border-radius: 14px;
      padding: 10px 12px; font-weight: 800; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    button.primary{ background:var(--brand); color:#fff; }
    button.secondary{ background:var(--soft); color:var(--text); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    main .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      align-items:start;
      padding: 14px 16px;
      max-width: 1280px;
      margin:0 auto;
    }
    @media (max-width: 980px){
      main .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .pad{ padding: 12px; }

    .hint{
      font-size:12px; color:var(--muted);
      line-height:1.35;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:12px; color:#374151; display:block; margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      border:1px solid #d8dbe6;
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      background:#fff;
    }
    textarea{ min-height: 70px; resize:vertical; }

    details{
      border-top:1px solid var(--line);
      background: #fbfbfe;
    }
    details summary{
      list-style:none;
      cursor:pointer;
      padding: 12px;
      font-weight: 800;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:space-between;
      user-select:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    details .pad{ padding: 12px; }

    .tog{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background:#fff;
      font-size:12px;
      color:#111;
      user-select:none;
    }
    .pill input{ width:auto; margin:0; }

    .err{
      color:var(--danger);
      font-size:12px;
      white-space:pre-wrap;
      border-top:1px solid var(--line);
      background:#fff5f7;
      padding: 10px 12px;
      display:none;
    }
    .ok{
      font-size:12px;
      color: var(--muted2);
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ✅ PREVIEW: mai retallat; si no cap, scroll */
    .canvasWrap{
      padding: 12px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:auto;
      max-height: calc(100vh - 140px); /* header + marges */
    }
    canvas{
      width:auto;
      height:auto;
      max-width: 100%;
      max-height: calc(100vh - 170px);
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--radius);
      display:block;
    }

    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:11px; }
    .spin{
      display:inline-block;
      width:14px; height:14px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,0.15);
      border-top-color: rgba(0,0,0,0.7);
      animation: r 0.7s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes r{ to{ transform:rotate(360deg);} }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="mark">G</div>
        <div>
          <h1>GEE Poster Composer</h1>
          <div class="sub">Obre’l des del visor · suport <span class="mono">?p=</span> (payload) i <span class="mono">?map=</span></div>
        </div>
      </div>
      <div class="btns">
        <button class="secondary" id="btnReset" title="Recarregar valors del payload">Recarregar</button>
        <button class="primary" id="btnRender">Generar</button>
        <button class="secondary" id="btnDownload">Descarregar PNG</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="pad">
        <label>Mapa (PNG) *</label>
        <input id="mapUrl" placeholder="getThumbURL del mapa base (PNG)" />

        <div class="row">
          <div style="flex:1">
            <label>Amplada pòster</label>
            <select id="posterW">
              <option value="2400">2400 px</option>
              <option value="3200" selected>3200 px</option>
              <option value="4000">4000 px</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Marge intern</label>
            <select id="padPx">
              <option value="44">Compacte</option>
              <option value="60" selected>Normal</option>
              <option value="78">Airejat</option>
            </select>
          </div>
        </div>

        <div class="tog">
          <label class="pill"><input type="checkbox" id="showLegend" checked> Llegenda</label>
          <label class="pill"><input type="checkbox" id="showNorth" checked> Nord</label>
          <label class="pill"><input type="checkbox" id="showScale"> Escala</label>
          <label class="pill"><input type="checkbox" id="showFooter" checked> Peu</label>
        </div>

        <div class="ok">
          <div id="status"></div>
          <div class="mono" id="fn"></div>
        </div>
      </div>

      <details id="adv">
        <summary>
          <span>Detalls (avançat)</span>
          <span class="mono">títol · llegenda</span>
        </summary>
        <div class="pad">
          <label>Títol</label>
          <input id="title" placeholder="Ex: Comparador insular" />

          <label>Subtítol (1–3 línies)</label>
          <textarea id="subtitle" placeholder="Ex: Variable · Mode · Any"></textarea>

          <div class="row">
            <div style="flex:1">
              <label>Min</label>
              <input id="vmin" placeholder="Ex: 0.12" />
            </div>
            <div style="flex:1">
              <label>Max</label>
              <input id="vmax" placeholder="Ex: 0.78" />
            </div>
            <div style="flex:1">
              <label>Unitat</label>
              <input id="unit" placeholder="Ex: NDVI / °C / mm" />
            </div>
          </div>

          <label>Paleta (hex separats per coma)</label>
          <input id="palette" placeholder="440154,3b528b,21918c,5ec962,fde725" />

          <div class="row">
            <div style="flex:1">
              <label>Escala (km) (si activada)</label>
              <input id="scaleKm" placeholder="Ex: 50" />
            </div>
            <div style="flex:1">
              <label>Amplada escala (px)</label>
              <input id="scalePx" placeholder="Ex: 180" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Peu</label>
              <input id="footer" placeholder="Ex: GEE · Copernicus · Consell Insular" />
            </div>
          </div>

          <div class="hint" style="margin-top:10px">
            Si la descàrrega falla, gairebé sempre és <b>CORS</b> (canvas “tainted”).
            En aquest cas, el PNG del mapa no es pot llegir dins el canvas.
          </div>
        </div>
      </details>

      <div class="err" id="err"></div>
    </section>

    <section class="card">
      <div class="canvasWrap">
        <canvas id="c" width="2400" height="1600"></canvas>
      </div>
    </section>
  </div>
</main>

<script>
(function(){
  // ---------- helpers ----------
  function $(id){ return document.getElementById(id); }
  function qs(k){ return new URLSearchParams(location.search).get(k); }
  function sanitize(s){ return (s===null||s===undefined) ? "" : String(s); }
  function setIf(id, v){
    var el = $(id);
    if(!el) return;
    if(v!==null && v!==undefined && v!==""){ el.value = v; }
  }

  function setErr(msg){
    var el = $("err");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }
  function setStatus(html){ $("status").innerHTML = html || ""; }

  function parsePalette(s){
    if(!s) return ["#440154","#3b528b","#21918c","#5ec962","#fde725"];
    return String(s).split(",").map(function(x){
      x = (x||"").trim().replace("#","");
      if(!x) return null;
      if(x.length===3) x = x[0]+x[0]+x[1]+x[1]+x[2]+x[2];
      return "#"+x;
    }).filter(Boolean);
  }

  function slug(s){
    return String(s||"").toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"")
      .slice(0,90) || "poster";
  }

  // ---------- drawing primitives ----------
  function drawRoundedRect(ctx,x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function drawNorthArrow(ctx, x, y, size){
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -size);
    ctx.lineTo(size*0.55, size*0.8);
    ctx.lineTo(0, size*0.45);
    ctx.lineTo(-size*0.55, size*0.8);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.moveTo(0, -size*0.72);
    ctx.lineTo(size*0.25, size*0.45);
    ctx.lineTo(0, size*0.25);
    ctx.lineTo(-size*0.25, size*0.45);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "#111";
    ctx.font = "800 " + Math.round(size*0.7) + "px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText("N", 0, -size*1.08);
    ctx.restore();
  }

  function drawDroplet(ctx, x, y, h){
    var w = h * 0.72;
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.moveTo(0, -h*0.5);
    ctx.bezierCurveTo(w*0.55, -h*0.3, w*0.55, h*0.15, 0, h*0.5);
    ctx.bezierCurveTo(-w*0.55, h*0.15, -w*0.55, -h*0.3, 0, -h*0.5);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function drawLegend(ctx, x,y,w,h, vmin, vmax, unit, palette){
    ctx.save();
    ctx.globalAlpha = 0.98;
    ctx.fillStyle = "#fff";
    drawRoundedRect(ctx,x,y,w,h,18);
    ctx.fill();

    ctx.globalAlpha = 1;
    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.lineWidth = 2;
    drawRoundedRect(ctx,x,y,w,h,18);
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = "800 20px system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText(unit || "Llegenda", x+16, y+14);

    var barX = x+16, barY = y+48, barW = w-32, barH = 18;
    var grad = ctx.createLinearGradient(barX,0,barX+barW,0);
    var stops = Math.max(1, palette.length-1);
    for(var i=0;i<palette.length;i++){
      grad.addColorStop(i/stops, palette[i]);
    }
    ctx.fillStyle = grad;
    drawRoundedRect(ctx,barX,barY,barW,barH,9);
    ctx.fill();

    ctx.fillStyle = "#333";
    ctx.font = "700 14px system-ui, sans-serif";
    ctx.textBaseline = "top";
    ctx.textAlign = "left";
    ctx.fillText(sanitize(vmin), barX, barY+barH+10);
    ctx.textAlign = "right";
    ctx.fillText(sanitize(vmax), barX+barW, barY+barH+10);
    ctx.restore();
  }

  function drawScaleBar(ctx, x, y, widthPx, label){
    ctx.save();
    ctx.fillStyle = "#111";
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x+widthPx, y);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(x, y-8); ctx.lineTo(x, y+8);
    ctx.moveTo(x+widthPx, y-8); ctx.lineTo(x+widthPx, y+8);
    ctx.stroke();

    ctx.font = "800 14px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText(label, x+widthPx/2, y-10);
    ctx.restore();
  }

  // ---------- payload / params ----------
  var initial = {};
  function loadFromQuery(){
    initial = {
      mapUrl: "",
      title: "",
      subtitle: "",
      vmin: "",
      vmax: "",
      unit: "",
      palette: "",
      scaleKm: "",
      scalePx: "",
      footer: "",
      filename: "poster.png"
    };

    var p = qs("p");
    if (p) {
      try{
        var payload = JSON.parse(decodeURIComponent(p));
        initial.mapUrl = payload.dataUrl || payload.mapUrl || payload.map || "";
        initial.title = payload.title || "Comparador insular";

        var sub = payload.subtitle || "";
        if(!sub && payload.meta){
          var m = payload.meta;
          var parts = [];
          if (m.mode) parts.push(m.mode);
          if (m.map) parts.push(m.map);
          if (m.island) parts.push(m.island);
          if (m.date) parts.push(m.date);
          sub = parts.join(" · ");
        }
        initial.subtitle = sub;

        if(payload.meta){
          initial.vmin = (payload.meta.min!==null && payload.meta.min!==undefined) ? String(payload.meta.min) : "";
          initial.vmax = (payload.meta.max!==null && payload.meta.max!==undefined) ? String(payload.meta.max) : "";
          initial.unit = payload.meta.unit || "";
          if(Array.isArray(payload.meta.palette)) initial.palette = payload.meta.palette.join(",");
        }

        var f = [
          payload.meta && payload.meta.island ? payload.meta.island : "",
          payload.subtitle || (payload.meta && payload.meta.map ? payload.meta.map : ""),
          payload.meta && payload.meta.date ? payload.meta.date : "",
          payload.meta && payload.meta.mode ? payload.meta.mode : ""
        ].filter(Boolean).join("_");
        initial.filename = slug(f || payload.title || "poster") + ".png";
      }catch(e){
        // ignore
      }
    }

    // fallback ?map=...
    if(!initial.mapUrl) initial.mapUrl = qs("map") || "";
    if(!initial.title) initial.title = qs("title") || initial.title;
    if(!initial.subtitle) initial.subtitle = qs("subtitle") || initial.subtitle;
    if(!initial.vmin) initial.vmin = qs("min") || "";
    if(!initial.vmax) initial.vmax = qs("max") || "";
    if(!initial.unit) initial.unit = qs("unit") || "";
    if(!initial.palette) initial.palette = qs("palette") || "";
    initial.scaleKm = qs("scalekm") || "";
    initial.scalePx = qs("scalepx") || "";
    initial.footer = qs("footer") || "";

    setIf("mapUrl", initial.mapUrl);
    setIf("title", initial.title);
    setIf("subtitle", initial.subtitle);
    setIf("vmin", initial.vmin);
    setIf("vmax", initial.vmax);
    setIf("unit", initial.unit);
    setIf("palette", initial.palette);
    setIf("scaleKm", initial.scaleKm);
    setIf("scalePx", initial.scalePx);
    setIf("footer", initial.footer);

    $("fn").textContent = initial.filename || "";
  }

  // ---------- render ----------
  var canvas = $("c");
  var ctx = canvas.getContext("2d");

  function setCanvasSize(outW, outH){
    var dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    canvas.width = outW * dpr;
    canvas.height = outH * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function render(){
    setErr("");
    $("btnRender").disabled = true;
    setStatus('<span class="spin"></span>Generant...');

    var mapUrl = $("mapUrl").value.trim();
    if(!mapUrl){
      setErr("Falta l'URL del mapa (PNG).");
      $("btnRender").disabled = false;
      setStatus("");
      return;
    }

    var posterW = parseInt($("posterW").value, 10) || 3200;
    var pad = parseInt($("padPx").value, 10) || 60;

    var title = $("title").value.trim() || "Pòster";
    var subtitle = ($("subtitle").value || "").trim();
    var vmin = $("vmin").value.trim();
    var vmax = $("vmax").value.trim();
    var unit = $("unit").value.trim();
    var palette = parsePalette($("palette").value);
    var scaleKm = $("scaleKm").value.trim();
    var scalePx = parseFloat($("scalePx").value.trim());
    if(!isFinite(scalePx) || scalePx<=0) scalePx = 180;

    // ✅ Marca fixa, no editable
    var brand = "Càtedra de la Insularitat";

    var footer = $("footer").value.trim();

    var showLegend = $("showLegend").checked;
    var showNorth  = $("showNorth").checked;
    var showScale  = $("showScale").checked;
    var showFooter = $("showFooter").checked;

    var headerH = 150;
    var subtitleMaxLines = 3;
    var mapTop = 240;

    var img = new Image();
    img.crossOrigin = "anonymous";

    img.onload = function(){
      var outW = posterW;
      var outH = Math.round(outW * 0.66);
      outH = Math.max(1600, Math.min(2400, outH));
      setCanvasSize(outW, outH);

      var W = outW, H = outH;

      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,H);

      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,headerH);
      ctx.strokeStyle = "rgba(0,0,0,0.06)";
      ctx.beginPath(); ctx.moveTo(0,headerH); ctx.lineTo(W,headerH); ctx.stroke();

      drawDroplet(ctx, pad, 72, 44);
      ctx.fillStyle = "#111";
      ctx.font = "900 22px system-ui, sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(brand, pad+42, 72);

      ctx.fillStyle = "#111";
      ctx.font = "950 30px system-ui, sans-serif";
      ctx.textBaseline = "top";
      ctx.fillText(title, pad, headerH + 10);

      ctx.font = "650 16px system-ui, sans-serif";
      ctx.fillStyle = "#374151";
      var lines = subtitle ? subtitle.split("\n").slice(0, subtitleMaxLines) : [];
      for(var i=0;i<lines.length;i++){
        ctx.fillText(lines[i], pad, headerH + 50 + i*20);
      }

      var mapX = pad;
      var mapY = mapTop;
      var mapW = W - pad*2;
      var mapH = H - mapTop - (showFooter ? 92 : 50);

      var ar = img.width / img.height;
      var targetAr = mapW / mapH;
      var drawW, drawH, dx, dy;
      if(ar > targetAr){
        drawW = mapW;
        drawH = mapW / ar;
        dx = mapX;
        dy = mapY + (mapH - drawH)/2;
      } else {
        drawH = mapH;
        drawW = mapH * ar;
        dx = mapX + (mapW - drawW)/2;
        dy = mapY;
      }

      ctx.fillStyle = "#fff";
      drawRoundedRect(ctx, mapX, mapY, mapW, mapH, 22);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.12)";
      ctx.lineWidth = 2;
      drawRoundedRect(ctx, mapX, mapY, mapW, mapH, 22);
      ctx.stroke();

      ctx.save();
      drawRoundedRect(ctx, mapX, mapY, mapW, mapH, 22);
      ctx.clip();
      ctx.drawImage(img, dx, dy, drawW, drawH);
      ctx.restore();

      if(showNorth){
        drawNorthArrow(ctx, mapX + mapW - 70, mapY + 85, 26);
      }
      if(showScale && scaleKm){
        var km = Number(scaleKm);
        if(isFinite(km) && km>0){
          drawScaleBar(ctx, mapX + 28, mapY + mapH - 28, scalePx, km + " km");
        }
      }
      if(showLegend){
        var legW = Math.min(460, Math.round(mapW * 0.36));
        var legH = 112;
        var legX = mapX + mapW - legW - 22;
        var legY = mapY + mapH - legH - 22;
        drawLegend(ctx, legX, legY, legW, legH, vmin, vmax, unit, palette);
      }

      if(showFooter){
        ctx.fillStyle = "#4b5563";
        ctx.font = "650 13px system-ui, sans-serif";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        ctx.fillText(footer || "", pad, H - 36);

        ctx.textAlign = "right";
        ctx.fillStyle = "#9ca3af";
        ctx.fillText("Generat amb GEE Poster Composer", W - pad, H - 36);
      }

      $("btnRender").disabled = false;
      setStatus("✅ Fet");
    };

    img.onerror = function(){
      $("btnRender").disabled = false;
      setStatus("");
      setErr(
        "No s'ha pogut carregar el PNG del mapa.\n\n" +
        "• Revisa que l'URL sigui correcte i no hagi expirat.\n" +
        "• Pot ser CORS: si el navegador bloqueja el PNG, el canvas no pot exportar.\n\n" +
        "Prova d'obrir l'URL del mapa en una pestanya nova: si no es veu, l'URL és invàlid o expirat."
      );
    };

    img.src = mapUrl;
  }

  function download(){
    setErr("");
    try{
      var name = $("fn").textContent || "poster.png";
      var a = document.createElement("a");
      a.download = name;
      a.href = canvas.toDataURL("image/png");
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){
      setErr(
        "No s'ha pogut exportar el canvas a PNG.\n\n" +
        "Això sol ser 'tainted canvas' per CORS.\nDetall:\n" + e
      );
    }
  }

  $("btnRender").addEventListener("click", render);
  $("btnDownload").addEventListener("click", download);
  $("btnReset").addEventListener("click", function(){
    loadFromQuery();
    setErr("");
    setStatus("");
  });

  loadFromQuery();
  if (qs("p") || qs("map")) setTimeout(render, 60);
})();
</script>
</body>
</html>

